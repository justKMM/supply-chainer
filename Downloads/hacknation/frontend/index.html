<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrari Supply Chain Agents — One Click AI</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root {
    --ferrari-red: #DC143C;
    --ferrari-dark: #8B0000;
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-card: #1a1a2e;
    --bg-card-hover: #22223a;
    --text-primary: #e8e8f0;
    --text-secondary: #8888aa;
    --text-muted: #555577;
    --border: #2a2a44;
    --accent-blue: #2196F3;
    --accent-green: #4CAF50;
    --accent-orange: #FF9800;
    --accent-purple: #9C27B0;
    --accent-yellow: #FFC107;
    --glow-red: rgba(220,20,60,0.15);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
  }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-secondary); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── Header ─────────────────────────────────────────────────── */
  .header {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, #0d0d18 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .logo {
    width: 48px; height: 48px;
    background: var(--ferrari-red);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; font-weight: 900; color: white;
    box-shadow: 0 0 20px var(--glow-red);
  }
  .header-title h1 {
    font-size: 20px; font-weight: 700;
    background: linear-gradient(90deg, var(--ferrari-red), #ff6b6b);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header-title p { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

  /* ── One Click Button ───────────────────────────────────────── */
  .trigger-btn {
    background: linear-gradient(135deg, var(--ferrari-red), var(--ferrari-dark));
    color: white; border: none; padding: 14px 32px;
    font-size: 15px; font-weight: 700; border-radius: 12px;
    cursor: pointer; transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(220,20,60,0.4);
    text-transform: uppercase; letter-spacing: 1px;
    font-family: 'Inter', sans-serif;
  }
  .trigger-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(220,20,60,0.6); }
  .trigger-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .trigger-btn.running {
    background: linear-gradient(135deg, #333, #222);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }

  /* ── Progress Bar ───────────────────────────────────────────── */
  .progress-container {
    padding: 0 40px;
    display: none;
  }
  .progress-container.active { display: block; }
  .progress-bar-outer {
    height: 4px; background: var(--bg-card);
    border-radius: 2px; overflow: hidden;
  }
  .progress-bar-inner {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--ferrari-red), #ff6b6b, var(--accent-orange));
    border-radius: 2px;
    transition: width 0.5s ease;
  }
  .progress-label {
    font-size: 11px; color: var(--text-secondary);
    margin-top: 4px; text-align: center;
  }

  /* ── Layout ─────────────────────────────────────────────────── */
  .main-content { padding: 24px 40px; }
  .section { margin-bottom: 28px; }
  .section-title {
    font-size: 14px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 2px; color: var(--text-secondary);
    margin-bottom: 14px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title .dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--ferrari-red);
    box-shadow: 0 0 8px var(--ferrari-red);
  }

  /* ── Hero Metrics ───────────────────────────────────────────── */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 14px;
  }
  .metric-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    text-align: center;
    transition: all 0.3s;
  }
  .metric-card:hover { border-color: var(--ferrari-red); background: var(--bg-card-hover); }
  .metric-value {
    font-size: 26px; font-weight: 800;
    background: linear-gradient(135deg, #fff, #ccc);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .metric-label { font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase; letter-spacing: 1px; }
  .metric-trend { font-size: 11px; margin-top: 4px; }
  .metric-trend.up { color: var(--accent-green); }

  /* ── Grid layouts ───────────────────────────────────────────── */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; }
  .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

  @media (max-width: 1200px) {
    .grid-2, .grid-3, .grid-2-1 { grid-template-columns: 1fr; }
    .main-content { padding: 16px 20px; }
    .header { padding: 16px 20px; }
  }

  /* ── Cards ──────────────────────────────────────────────────── */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }
  .card-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 13px; font-weight: 600;
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-body { padding: 18px; }
  .card-body.no-pad { padding: 0; }

  /* ── Network Graph ──────────────────────────────────────────── */
  #network-graph { height: 420px; width: 100%; }

  /* ── Message Feed ───────────────────────────────────────────── */
  .feed-container { max-height: 420px; overflow-y: auto; }
  .feed-msg {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(42,42,68,0.5);
    font-size: 12px;
    animation: fadeIn 0.3s ease;
    transition: background 0.2s;
  }
  .feed-msg:hover { background: rgba(255,255,255,0.02); }
  .feed-msg-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .feed-badge {
    padding: 2px 8px; border-radius: 4px; font-size: 10px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .feed-from { font-weight: 600; color: var(--text-primary); }
  .feed-arrow { color: var(--text-muted); font-size: 10px; }
  .feed-to { color: var(--text-secondary); }
  .feed-summary { color: var(--text-primary); margin-top: 3px; line-height: 1.4; }
  .feed-detail { color: var(--text-muted); font-size: 11px; margin-top: 2px; }
  .feed-time { color: var(--text-muted); font-size: 10px; margin-left: auto; }

  @keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }

  /* ── Map ─────────────────────────────────────────────────────── */
  #supplier-map { height: 350px; width: 100%; border-radius: 0 0 14px 14px; }
  .leaflet-container { background: #0a0a15; }

  /* ── Charts ─────────────────────────────────────────────────── */
  .chart-container { position: relative; height: 250px; }

  /* ── Timeline / Gantt ───────────────────────────────────────── */
  .gantt-container { padding: 8px 0; }
  .gantt-row {
    display: flex; align-items: center; gap: 12px;
    padding: 6px 16px; font-size: 12px;
  }
  .gantt-label { width: 200px; min-width: 200px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .gantt-bar-container { flex: 1; height: 22px; position: relative; background: rgba(255,255,255,0.03); border-radius: 4px; }
  .gantt-bar {
    position: absolute; height: 100%; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 600; color: white;
    min-width: 30px;
  }
  .gantt-bar.critical { box-shadow: 0 0 8px rgba(244,67,54,0.5); }
  .gantt-days { width: 60px; text-align: right; color: var(--text-muted); font-size: 11px; }

  /* ── Risk Panel ─────────────────────────────────────────────── */
  .risk-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(42,42,68,0.5);
  }
  .risk-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    margin-right: 8px;
  }
  .risk-badge.high { background: rgba(244,67,54,0.2); color: #F44336; }
  .risk-badge.medium { background: rgba(255,152,0,0.2); color: #FF9800; }
  .risk-badge.low { background: rgba(76,175,80,0.2); color: #4CAF50; }
  .risk-title { font-size: 13px; font-weight: 600; display: inline; }
  .risk-detail { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
  .risk-mitigation { font-size: 11px; color: var(--accent-green); margin-top: 3px; }

  /* ── Reasoning Log ──────────────────────────────────────────── */
  .reasoning-container { max-height: 350px; overflow-y: auto; }
  .reasoning-item {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(42,42,68,0.5);
    font-size: 12px;
  }
  .reasoning-agent { font-weight: 600; color: var(--ferrari-red); margin-bottom: 3px; display:flex; align-items:center; gap: 6px; }
  .reasoning-thought { color: var(--text-secondary); line-height: 1.5; font-style: italic; }

  /* ── Negotiation Panel ──────────────────────────────────────── */
  .negotiation-item { padding: 14px 16px; border-bottom: 1px solid rgba(42,42,68,0.5); }
  .negotiation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .negotiation-product { font-weight: 600; font-size: 13px; }
  .negotiation-supplier { font-size: 12px; color: var(--text-secondary); }
  .negotiation-rounds { display: flex; gap: 8px; align-items: center; }
  .negotiation-round {
    display: flex; flex-direction: column; align-items: center;
    padding: 6px 10px; background: rgba(255,255,255,0.03);
    border-radius: 6px; font-size: 11px;
  }
  .negotiation-round .price { font-weight: 700; font-size: 13px; }
  .negotiation-round .label { color: var(--text-muted); font-size: 9px; text-transform: uppercase; }
  .negotiation-arrow { color: var(--text-muted); font-size: 16px; }
  .negotiation-savings { font-size: 11px; color: var(--accent-green); margin-top: 6px; }

  /* ── Compliance ─────────────────────────────────────────────── */
  .compliance-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    padding: 12px;
  }
  .compliance-stat {
    text-align: center; padding: 12px; background: rgba(255,255,255,0.02);
    border-radius: 8px;
  }
  .compliance-stat .number { font-size: 28px; font-weight: 800; }
  .compliance-stat .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
  .compliance-stat.pass .number { color: var(--accent-green); }
  .compliance-stat.flag .number { color: var(--accent-orange); }
  .compliance-stat.fail .number { color: #F44336; }
  .compliance-stat.total .number { color: var(--accent-blue); }

  /* ── Empty State ────────────────────────────────────────────── */
  .empty-state {
    text-align: center; padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state h3 { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
  .empty-state p { font-size: 13px; max-width: 400px; margin: 0 auto; line-height: 1.6; }

  /* ── Discovery Paths ────────────────────────────────────────── */
  .discovery-item { padding: 10px 16px; border-bottom: 1px solid rgba(42,42,68,0.5); font-size: 12px; }
  .discovery-need { font-weight: 600; color: var(--text-primary); }
  .discovery-query { color: var(--text-muted); font-family: monospace; font-size: 11px; margin: 3px 0; }
  .discovery-result { color: var(--accent-green); }

  /* ── Reputation Leaderboard ────────────────────────────────── */
  .reputation-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .reputation-table th {
    text-align: left; padding: 8px 12px; font-size: 10px;
    text-transform: uppercase; letter-spacing: 1px;
    color: var(--text-muted); border-bottom: 1px solid var(--border);
  }
  .reputation-table td {
    padding: 8px 12px; border-bottom: 1px solid rgba(42,42,68,0.3);
  }
  .reputation-table tr:hover td { background: rgba(255,255,255,0.02); }
  .score-bar {
    display: inline-block; height: 6px; border-radius: 3px;
    margin-right: 6px; vertical-align: middle;
  }
  .score-value { font-weight: 700; font-size: 13px; }
  .chain-badge {
    display: inline-block; padding: 2px 6px; border-radius: 3px;
    font-size: 9px; font-weight: 700; text-transform: uppercase;
  }
  .chain-badge.valid { background: rgba(76,175,80,0.2); color: #4CAF50; }
  .chain-badge.invalid { background: rgba(244,67,54,0.2); color: #F44336; }
  .trend-indicator { font-size: 11px; }
  .trend-indicator.improving { color: var(--accent-green); }
  .trend-indicator.stable { color: var(--text-muted); }
  .trend-indicator.declining { color: #F44336; }

  /* ── Intelligence Feed ─────────────────────────────────────── */
  .intel-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(42,42,68,0.5);
  }
  .intel-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .intel-severity {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 700; text-transform: uppercase;
  }
  .intel-severity.critical { background: rgba(211,47,47,0.2); color: #D32F2F; }
  .intel-severity.high { background: rgba(244,67,54,0.2); color: #F44336; }
  .intel-severity.medium { background: rgba(255,152,0,0.2); color: #FF9800; }
  .intel-severity.low { background: rgba(76,175,80,0.2); color: #4CAF50; }
  .intel-source { font-size: 10px; color: var(--text-muted); }
  .intel-title { font-weight: 600; font-size: 13px; color: var(--text-primary); }
  .intel-desc { font-size: 11px; color: var(--text-secondary); margin: 4px 0; line-height: 1.5; }
  .intel-actions { font-size: 11px; color: var(--accent-blue); margin-top: 4px; }
  .intel-recipients { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
  .intel-reaction {
    margin-top: 6px; padding: 8px 12px;
    background: rgba(220,20,60,0.05); border-left: 3px solid var(--ferrari-red);
    border-radius: 0 6px 6px 0; font-size: 11px;
    color: var(--text-secondary); font-style: italic;
  }

  /* ── Pub-Sub Subscriptions ─────────────────────────────────── */
  .sub-item {
    padding: 8px 16px;
    border-bottom: 1px solid rgba(42,42,68,0.3);
    font-size: 12px;
  }
  .sub-agent { font-weight: 600; color: var(--text-primary); }
  .sub-categories { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .sub-tag {
    padding: 1px 6px; border-radius: 3px; font-size: 9px;
    font-weight: 600; text-transform: uppercase;
    background: rgba(0,188,212,0.15); color: #00BCD4;
  }
  .sub-stat { display: flex; gap: 16px; margin-top: 8px; }
  .sub-stat-item { text-align: center; }
  .sub-stat-item .num { font-size: 20px; font-weight: 800; color: #00BCD4; }
  .sub-stat-item .lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
</style>
</head>
<body>

<!-- ── HEADER ──────────────────────────────────────────────────── -->
<header class="header">
  <div class="header-left">
    <div class="logo">F</div>
    <div class="header-title">
      <h1>Ferrari Supply Chain Agents</h1>
      <p>NANDA-Native Internet of Agents &mdash; One Click Procurement</p>
    </div>
  </div>
  <button class="trigger-btn" id="triggerBtn" onclick="triggerCascade()">
    Buy Ferrari in One Click
  </button>
</header>

<!-- ── PROGRESS ────────────────────────────────────────────────── -->
<div class="progress-container" id="progressContainer">
  <div class="progress-bar-outer">
    <div class="progress-bar-inner" id="progressBar"></div>
  </div>
  <div class="progress-label" id="progressLabel">Initializing cascade...</div>
</div>

<div class="main-content">

  <!-- ── Empty State (before trigger) ──────────────────────────── -->
  <div id="emptyState" class="empty-state">
    <div class="icon">&#9881;</div>
    <h3>Supply Chain Agent Network Ready</h3>
    <p>Click "Buy Ferrari in One Click" to launch the full AI-powered procurement cascade.
       Watch as autonomous agents discover suppliers, negotiate prices, validate compliance,
       and orchestrate logistics in real time.</p>
  </div>

  <!-- ── Dashboard (after trigger) ─────────────────────────────── -->
  <div id="dashboard" style="display:none;">

    <!-- Hero Metrics -->
    <div class="section">
      <div class="section-title"><span class="dot"></span> Key Metrics</div>
      <div class="metrics-grid" id="metricsGrid"></div>
    </div>

    <!-- Row 1: Network Graph + Live Feed -->
    <div class="section grid-2">
      <div class="card">
        <div class="card-header">
          <span>Supply Network Graph</span>
          <span style="font-size:11px;color:var(--text-muted)" id="nodeCount"></span>
        </div>
        <div class="card-body no-pad">
          <div id="network-graph"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Live Agent Communication</span>
          <span style="font-size:11px;color:var(--text-muted)" id="msgCount">0 messages</span>
        </div>
        <div class="card-body no-pad">
          <div class="feed-container" id="feedContainer"></div>
        </div>
      </div>
    </div>

    <!-- Row 2: Map + Cost Breakdown -->
    <div class="section grid-2-1">
      <div class="card">
        <div class="card-header">Supplier Network Map</div>
        <div class="card-body no-pad">
          <div id="supplier-map"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Cost Breakdown</div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="costChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Timeline + Negotiations -->
    <div class="section grid-2">
      <div class="card">
        <div class="card-header">Procurement Timeline</div>
        <div class="card-body no-pad">
          <div class="gantt-container" id="ganttContainer"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Negotiation Summary</div>
        <div class="card-body no-pad" style="max-height:350px;overflow-y:auto;">
          <div id="negotiationContainer"></div>
        </div>
      </div>
    </div>

    <!-- Row 4: Risk + Compliance + Discovery -->
    <div class="section grid-3">
      <div class="card">
        <div class="card-header">
          <span>Risk Assessment</span>
          <span class="risk-badge medium" id="overallRisk">MEDIUM</span>
        </div>
        <div class="card-body no-pad" id="riskContainer"></div>
      </div>
      <div class="card">
        <div class="card-header">Compliance Summary</div>
        <div class="card-body no-pad" id="complianceContainer"></div>
      </div>
      <div class="card">
        <div class="card-header">Discovery Paths</div>
        <div class="card-body no-pad" style="max-height:300px;overflow-y:auto;" id="discoveryContainer"></div>
      </div>
    </div>

    <!-- Row 5: Intelligence Feed + Pub-Sub -->
    <div class="section grid-2">
      <div class="card">
        <div class="card-header">
          <span>Network Intelligence Feed</span>
          <span style="font-size:11px;color:var(--text-muted)" id="intelCount"></span>
        </div>
        <div class="card-body no-pad" style="max-height:450px;overflow-y:auto;">
          <div id="intelContainer"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Event Subscriptions (Pub-Sub)</span>
          <span style="font-size:11px;color:var(--text-muted)" id="subCount"></span>
        </div>
        <div class="card-body no-pad" style="max-height:450px;overflow-y:auto;">
          <div id="pubsubContainer"></div>
        </div>
      </div>
    </div>

    <!-- Row 6: Reputation Leaderboard -->
    <div class="section">
      <div class="card">
        <div class="card-header">
          <span>Verifiable Reputation Leaderboard</span>
          <span style="font-size:11px;color:var(--text-muted)" id="reputationCount"></span>
        </div>
        <div class="card-body no-pad" style="overflow-x:auto;">
          <div id="reputationContainer"></div>
        </div>
      </div>
    </div>

    <!-- Row 7: Agent Reasoning Log -->
    <div class="section">
      <div class="card">
        <div class="card-header">
          <span>Agent Reasoning Log (AI-Powered Decisions)</span>
          <span style="font-size:11px;color:var(--text-muted)" id="reasoningCount"></span>
        </div>
        <div class="card-body no-pad">
          <div class="reasoning-container" id="reasoningContainer"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// ── State ────────────────────────────────────────────────────────────────────
let eventSource = null;
let messageCount = 0;
let networkInstance = null;
let mapInstance = null;
let costChartInstance = null;
let reportData = null;

const TYPE_COLORS = {
  discovery: '#2196F3', request_quote: '#4CAF50', quote_response: '#4CAF50',
  negotiate: '#FF9800', negotiate_response: '#FF9800', purchase_order: '#DC143C',
  order_confirmation: '#4CAF50', logistics_request: '#9C27B0', logistics_proposal: '#9C27B0',
  compliance_check: '#FF9800', compliance_result: '#4CAF50',
  disruption_alert: '#F44336', resolution: '#4CAF50',
  intent_decomposition: '#DC143C', bom_complete: '#DC143C',
  cascade_complete: '#DC143C', system: '#9E9E9E',
  discovery_result: '#4CAF50',
  pubsub_init: '#00BCD4', attestation: '#00BCD4', reputation_init: '#00BCD4',
  intel_init: '#E91E63', intel_complete: '#E91E63',
  intel_weather_disruption: '#F44336', intel_regulatory_change: '#FF9800',
  intel_price_volatility: '#F44336', intel_port_congestion: '#FF9800',
  intel_quality_recall: '#D32F2F', intel_geopolitical: '#FF9800',
  intel_labor_dispute: '#FF9800', intel_capacity_constraint: '#F44336',
  intel_material_shortage: '#F44336', intel_response: '#DC143C',
};

const TYPE_ICONS = {
  discovery: '\u{1F50D}', request_quote: '\u{1F4E9}', quote_response: '\u{1F4E8}',
  negotiate: '\u{1F91D}', negotiate_response: '\u{1F91D}', purchase_order: '\u{1F4DD}',
  order_confirmation: '\u2705', logistics_request: '\u{1F69A}', logistics_proposal: '\u{1F6E3}',
  compliance_check: '\u{1F6E1}', compliance_result: '\u2705',
  disruption_alert: '\u26A0\uFE0F', resolution: '\u2705',
  intent_decomposition: '\u{1F9E0}', bom_complete: '\u{1F4CB}',
  cascade_complete: '\u{1F3C6}', system: '\u2699\uFE0F',
  discovery_result: '\u2705',
  pubsub_init: '\u{1F4E1}', attestation: '\u{1F4DC}', reputation_init: '\u{1F4DC}',
  intel_init: '\u{1F6F0}', intel_complete: '\u{1F6F0}',
  intel_weather_disruption: '\u26C8\uFE0F', intel_regulatory_change: '\u2696\uFE0F',
  intel_price_volatility: '\u{1F4C8}', intel_port_congestion: '\u{1F6A2}',
  intel_quality_recall: '\u{1F6A8}', intel_geopolitical: '\u{1F30D}',
  intel_labor_dispute: '\u{1F3ED}', intel_capacity_constraint: '\u{1F527}',
  intel_material_shortage: '\u26A0\uFE0F', intel_response: '\u{1F9E0}',
};

// ── Trigger ──────────────────────────────────────────────────────────────────
async function triggerCascade() {
  const btn = document.getElementById('triggerBtn');
  btn.disabled = true;
  btn.textContent = 'Cascade Running...';
  btn.classList.add('running');

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('progressContainer').classList.add('active');
  document.getElementById('feedContainer').innerHTML = '';
  messageCount = 0;

  // Start SSE
  startSSE();

  // Trigger cascade
  try {
    await fetch('/registry/trigger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        intent: 'Buy all parts required to assemble one Ferrari 296 GTB',
        budget_eur: 500000
      })
    });
  } catch(e) {
    console.error('Trigger failed:', e);
  }

  // Poll progress
  pollProgress();
}

async function pollProgress() {
  const interval = setInterval(async () => {
    try {
      const resp = await fetch('/api/progress');
      const data = await resp.json();
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressLabel');
      bar.style.width = data.progress + '%';

      const stages = [
        [0, 'Initializing agent network & event subscriptions...'],
        [10, 'Decomposing intent into Bill of Materials...'],
        [20, 'Discovering suppliers across registry...'],
        [40, 'Requesting quotes from qualified suppliers...'],
        [55, 'Negotiating prices with suppliers...'],
        [70, 'Running compliance checks...'],
        [80, 'Issuing purchase orders...'],
        [88, 'Planning logistics routes...'],
        [91, 'Simulating disruption & recovery...'],
        [93, 'Recording transaction attestations...'],
        [95, 'Scanning intelligence feeds (weather, regulatory, commodity)...'],
        [97, 'Generating final report...'],
      ];
      let stageText = 'Processing...';
      for (const [thresh, text] of stages) {
        if (data.progress >= thresh) stageText = text;
      }
      label.textContent = `${data.progress}% — ${stageText}`;

      if (!data.running && data.progress >= 100) {
        clearInterval(interval);
        document.getElementById('progressContainer').classList.remove('active');
        const btn = document.getElementById('triggerBtn');
        btn.disabled = false;
        btn.textContent = 'Buy Ferrari in One Click';
        btn.classList.remove('running');
        loadReport();
      }
    } catch(e) {}
  }, 500);
}

// ── SSE Live Feed ────────────────────────────────────────────────────────────
function startSSE() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource('/api/stream');
  eventSource.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'heartbeat') return;
    addMessageToFeed(msg);
  };
}

function addMessageToFeed(msg) {
  messageCount++;
  document.getElementById('msgCount').textContent = messageCount + ' messages';
  const container = document.getElementById('feedContainer');
  const color = TYPE_COLORS[msg.type] || '#666';
  const icon = TYPE_ICONS[msg.type] || '\u2139\uFE0F';
  const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '';

  const div = document.createElement('div');
  div.className = 'feed-msg';
  div.innerHTML = `
    <div class="feed-msg-header">
      <span>${icon}</span>
      <span class="feed-badge" style="background:${color}22;color:${color}">${msg.type.replace(/_/g,' ')}</span>
      <span class="feed-from">${msg.from_label||msg.from_id||''}</span>
      <span class="feed-arrow">\u2192</span>
      <span class="feed-to">${msg.to_label||msg.to_id||''}</span>
      <span class="feed-time">${time}</span>
    </div>
    <div class="feed-summary">${msg.summary||''}</div>
    ${msg.detail ? `<div class="feed-detail">${msg.detail}</div>` : ''}
  `;
  container.insertBefore(div, container.firstChild);

  // Keep max 100 messages in DOM
  while (container.children.length > 100) {
    container.removeChild(container.lastChild);
  }
}

// ── Load Report ──────────────────────────────────────────────────────────────
async function loadReport() {
  try {
    const resp = await fetch('/api/report');
    reportData = await resp.json();
    renderDashboard(reportData);
  } catch(e) {
    console.error('Failed to load report:', e);
    // Retry after 2s
    setTimeout(loadReport, 2000);
  }
}

function renderDashboard(report) {
  renderMetrics(report);
  renderNetworkGraph(report);
  renderMap(report);
  renderCostChart(report);
  renderTimeline(report);
  renderNegotiations(report);
  renderRisks(report);
  renderCompliance(report);
  renderDiscovery(report);
  renderIntelligence(report);
  renderPubSub(report);
  renderReputation(report);
  renderReasoning(report);
}

// ── Hero Metrics ─────────────────────────────────────────────────────────────
function renderMetrics(report) {
  const grid = document.getElementById('metricsGrid');
  const metrics = report.dashboard?.hero_metrics || [];
  grid.innerHTML = metrics.map(m => `
    <div class="metric-card">
      <div class="metric-value">${m.value}</div>
      <div class="metric-label">${m.label}</div>
      ${m.trend ? `<div class="metric-trend ${m.trend}">\u2191 ${m.trend}</div>` : ''}
    </div>
  `).join('');
}

// ── Network Graph ────────────────────────────────────────────────────────────
function renderNetworkGraph(report) {
  const nodes = (report.graph_nodes || []).map(n => ({
    id: n.id,
    label: n.label,
    color: { background: n.color, border: n.color, highlight: { background: n.color, border: '#fff' } },
    size: n.size || 25,
    font: { color: '#ddd', size: 11, face: 'Inter' },
    shape: n.role === 'procurement_agent' ? 'diamond' :
           n.role === 'logistics_provider' ? 'triangle' :
           n.role === 'compliance_agent' ? 'square' :
           n.role === 'assembly_coordinator' ? 'star' : 'dot',
    title: `${n.label}\nRole: ${n.role}\nTrust: ${n.trust_score || 'N/A'}`,
  }));

  const edges = (report.graph_edges || []).map(e => ({
    from: e.from,
    to: e.to,
    label: e.label || '',
    color: { color: e.type === 'procurement' ? '#DC143C44' :
                    e.type === 'logistics' ? '#9C27B044' :
                    e.type === 'compliance' ? '#FF980044' : '#2196F344',
             highlight: '#fff' },
    width: e.type === 'procurement' ? 2 : 1,
    font: { color: '#666', size: 9, face: 'Inter' },
    arrows: 'to',
    smooth: { type: 'curvedCW', roundness: 0.2 },
    title: `${e.type}: ${e.label}\n${e.value_eur ? 'EUR ' + e.value_eur.toLocaleString() : ''}`,
  }));

  document.getElementById('nodeCount').textContent = `${nodes.length} agents, ${edges.length} connections`;

  const container = document.getElementById('network-graph');
  const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
  const options = {
    physics: {
      stabilization: { iterations: 100 },
      barnesHut: { gravitationalConstant: -3000, centralGravity: 0.3, springLength: 150 }
    },
    interaction: { hover: true, tooltipDelay: 200 },
    layout: { improvedLayout: true },
  };
  if (networkInstance) networkInstance.destroy();
  networkInstance = new vis.Network(container, data, options);
}

// ── Supplier Map ─────────────────────────────────────────────────────────────
function renderMap(report) {
  const markers = report.dashboard?.supplier_markers || [];
  const routes = report.dashboard?.supplier_routes || [];

  if (mapInstance) { mapInstance.remove(); mapInstance = null; }

  mapInstance = L.map('supplier-map', {
    zoomControl: true,
    scrollWheelZoom: true,
  }).setView([45.0, 10.5], 6);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; CartoDB',
    maxZoom: 18,
  }).addTo(mapInstance);

  markers.forEach(m => {
    const markerIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="width:14px;height:14px;background:${m.color};border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px ${m.color}"></div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7],
    });
    L.marker([m.lat, m.lon], { icon: markerIcon })
      .addTo(mapInstance)
      .bindPopup(`<b style="color:#333">${m.label}</b><br><span style="color:#666">${m.type}</span>`);
  });

  routes.forEach(r => {
    L.polyline([[r.from.lat, r.from.lon], [r.to.lat, r.to.lon]], {
      color: '#DC143C', weight: 1.5, opacity: 0.5, dashArray: '6,4',
    }).addTo(mapInstance);
  });

  setTimeout(() => mapInstance.invalidateSize(), 100);
}

// ── Cost Chart ───────────────────────────────────────────────────────────────
function renderCostChart(report) {
  const items = report.dashboard?.cost_breakdown || [];
  if (costChartInstance) costChartInstance.destroy();

  const ctx = document.getElementById('costChart').getContext('2d');
  costChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: items.map(i => i.label),
      datasets: [{
        data: items.map(i => i.value),
        backgroundColor: items.map(i => i.color),
        borderWidth: 0,
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#888', font: { size: 11, family: 'Inter' }, padding: 12 }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: EUR ${ctx.parsed.toLocaleString()}`
          }
        }
      }
    }
  });
}

// ── Timeline / Gantt ─────────────────────────────────────────────────────────
function renderTimeline(report) {
  const items = report.dashboard?.timeline_items || [];
  const container = document.getElementById('ganttContainer');
  if (!items.length) { container.innerHTML = '<div class="empty-state"><p>No timeline data</p></div>'; return; }

  const maxDays = Math.max(...items.map(i => i.lead_time_days || 14));
  const catColors = {
    powertrain: '#DC143C', braking_system: '#2196F3', body_chassis: '#4CAF50',
    electronics: '#FF9800', interior: '#9C27B0', suspension: '#00BCD4',
    wheels_tires: '#FFC107', exhaust_emissions: '#F44336',
  };

  container.innerHTML = items.map(item => {
    const days = item.lead_time_days || 14;
    const widthPct = (days / (maxDays + 5)) * 100;
    const color = catColors[item.category] || '#2196F3';
    const critical = item.critical_path ? 'critical' : '';
    return `
      <div class="gantt-row">
        <div class="gantt-label" title="${item.label}">${item.label}</div>
        <div class="gantt-bar-container">
          <div class="gantt-bar ${critical}" style="width:${widthPct}%;background:${color};left:0">${days}d</div>
        </div>
        <div class="gantt-days">${days} days</div>
      </div>
    `;
  }).join('');
}

// ── Negotiations ─────────────────────────────────────────────────────────────
function renderNegotiations(report) {
  const negotiations = report.negotiations || [];
  const container = document.getElementById('negotiationContainer');

  container.innerHTML = negotiations.map(n => `
    <div class="negotiation-item">
      <div class="negotiation-header">
        <div>
          <div class="negotiation-product">${n.product}</div>
          <div class="negotiation-supplier">${n.with_name || n.with_agent}</div>
        </div>
        <span class="risk-badge low">${n.rounds} rounds</span>
      </div>
      <div class="negotiation-rounds">
        <div class="negotiation-round">
          <span class="label">Ask</span>
          <span class="price" style="color:#F44336">EUR ${n.initial_ask_eur?.toLocaleString()}</span>
        </div>
        <span class="negotiation-arrow">\u2192</span>
        <div class="negotiation-round">
          <span class="label">Offer</span>
          <span class="price" style="color:#FF9800">EUR ${n.initial_offer_eur?.toLocaleString()}</span>
        </div>
        <span class="negotiation-arrow">\u2192</span>
        <div class="negotiation-round">
          <span class="label">Agreed</span>
          <span class="price" style="color:#4CAF50">EUR ${n.final_agreed_eur?.toLocaleString()}</span>
        </div>
      </div>
      <div class="negotiation-savings">Discount: ${n.discount_pct?.toFixed(1)}%</div>
    </div>
  `).join('') || '<div class="empty-state"><p>No negotiations yet</p></div>';
}

// ── Risks ────────────────────────────────────────────────────────────────────
function renderRisks(report) {
  const risks = report.dashboard?.risk_items || report.execution_plan?.risk_assessment?.risks || [];
  const container = document.getElementById('riskContainer');
  const overall = report.execution_plan?.risk_assessment?.overall_risk || 'medium';
  document.getElementById('overallRisk').textContent = overall.toUpperCase();
  document.getElementById('overallRisk').className = `risk-badge ${overall}`;

  container.innerHTML = risks.map(r => `
    <div class="risk-item">
      <span class="risk-badge ${r.type === 'single_source_dependency' ? 'high' : 'low'}">${r.type === 'single_source_dependency' ? 'HIGH' : 'LOW'}</span>
      <span class="risk-title">${r.type?.replace(/_/g, ' ')}: ${r.component || ''}</span>
      <div class="risk-detail">${r.detail || r.supplier || ''}</div>
      <div class="risk-mitigation">\u2192 ${r.mitigation || ''}</div>
    </div>
  `).join('') || '<div class="empty-state"><p>No risks identified</p></div>';
}

// ── Compliance ───────────────────────────────────────────────────────────────
function renderCompliance(report) {
  const comp = report.compliance_summary || {};
  const container = document.getElementById('complianceContainer');
  container.innerHTML = `
    <div class="compliance-grid">
      <div class="compliance-stat total"><div class="number">${comp.total_checks||0}</div><div class="label">Total Checks</div></div>
      <div class="compliance-stat pass"><div class="number">${comp.passed||0}</div><div class="label">Passed</div></div>
      <div class="compliance-stat flag"><div class="number">${comp.flagged||0}</div><div class="label">Flagged</div></div>
      <div class="compliance-stat fail"><div class="number">${comp.failed||0}</div><div class="label">Failed</div></div>
    </div>
    ${(comp.flags||[]).map(f => `
      <div class="risk-item">
        <span class="risk-badge medium">WARNING</span>
        <span class="risk-title">${f.agent_id}</span>
        <div class="risk-detail">${f.detail}</div>
      </div>
    `).join('')}
  `;
}

// ── Discovery ────────────────────────────────────────────────────────────────
function renderDiscovery(report) {
  const paths = report.discovery_results?.discovery_paths || [];
  const container = document.getElementById('discoveryContainer');

  container.innerHTML = `
    <div style="padding:10px 16px;border-bottom:1px solid rgba(42,42,68,0.5);font-size:12px;">
      <span style="color:var(--accent-blue);font-weight:600">${report.discovery_results?.agents_discovered||0}</span> discovered &bull;
      <span style="color:var(--accent-green);font-weight:600">${report.discovery_results?.agents_qualified||0}</span> qualified &bull;
      <span style="color:#F44336;font-weight:600">${report.discovery_results?.agents_disqualified||0}</span> disqualified
    </div>
  ` + paths.map(p => `
    <div class="discovery-item">
      <div class="discovery-need">${p.need}</div>
      <div class="discovery-query">${p.query}</div>
      <div class="discovery-result">\u2192 ${p.selected} (${p.results_count} candidates)</div>
    </div>
  `).join('');
}

// ── Reasoning Log ────────────────────────────────────────────────────────────
function renderReasoning(report) {
  const log = report.reasoning_log || [];
  const container = document.getElementById('reasoningContainer');
  document.getElementById('reasoningCount').textContent = `${log.length} decisions`;

  container.innerHTML = log.map(r => `
    <div class="reasoning-item">
      <div class="reasoning-agent">
        <span style="color:${r.agent.includes('Ferrari') ? 'var(--ferrari-red)' : 'var(--accent-blue)'}">${r.agent}</span>
      </div>
      <div class="reasoning-thought">"${r.thought}"</div>
    </div>
  `).join('') || '<div class="empty-state"><p>No reasoning data</p></div>';
}

// ── Intelligence Feed ────────────────────────────────────────────────────────
function renderIntelligence(report) {
  const signals = report.intelligence_feed || [];
  const container = document.getElementById('intelContainer');
  document.getElementById('intelCount').textContent = `${signals.length} signals`;

  container.innerHTML = signals.map(s => {
    const evt = s.event || {};
    const severity = evt.severity || 'medium';
    const actions = (evt.recommended_actions || []).slice(0, 3);
    return `
      <div class="intel-item">
        <div class="intel-header">
          <span class="intel-severity ${severity}">${severity}</span>
          <span class="sub-tag">${(evt.category || '').replace(/_/g, ' ')}</span>
          <span class="intel-source">${evt.source || ''}</span>
        </div>
        <div class="intel-title">${evt.title || ''}</div>
        <div class="intel-desc">${evt.description || ''}</div>
        ${actions.length ? `<div class="intel-actions">Recommended: ${actions.join(' | ')}</div>` : ''}
        <div class="intel-recipients">Delivered to ${s.recipient_count || 0} subscribed agents</div>
        ${s.ai_reaction ? `<div class="intel-reaction">Ferrari Procurement: "${s.ai_reaction}"</div>` : ''}
      </div>
    `;
  }).join('') || '<div class="empty-state"><p>No intelligence signals</p></div>';
}

// ── Pub-Sub Subscriptions ────────────────────────────────────────────────────
function renderPubSub(report) {
  const summary = report.pubsub_summary || {};
  const subs = summary.subscriptions || [];
  const container = document.getElementById('pubsubContainer');
  document.getElementById('subCount').textContent = `${subs.length} agents`;

  let html = `
    <div class="sub-stat" style="padding:12px 16px;border-bottom:1px solid var(--border);">
      <div class="sub-stat-item"><div class="num">${summary.total_events || 0}</div><div class="lbl">Events</div></div>
      <div class="sub-stat-item"><div class="num">${summary.total_subscriptions || 0}</div><div class="lbl">Subscribers</div></div>
      <div class="sub-stat-item"><div class="num">${summary.total_deliveries || 0}</div><div class="lbl">Deliveries</div></div>
    </div>
  `;

  html += subs.map(s => `
    <div class="sub-item">
      <div class="sub-agent">${s.agent_name || s.agent_id}</div>
      <div class="sub-categories">
        ${(s.categories || []).map(c => `<span class="sub-tag">${c.replace(/_/g, ' ')}</span>`).join('')}
      </div>
    </div>
  `).join('');

  container.innerHTML = html || '<div class="empty-state"><p>No subscriptions</p></div>';
}

// ── Reputation Leaderboard ───────────────────────────────────────────────────
function renderReputation(report) {
  const rep = report.reputation_summary || {};
  const leaderboard = rep.leaderboard || [];
  const chains = rep.chain_verifications || {};
  const container = document.getElementById('reputationContainer');
  document.getElementById('reputationCount').textContent =
    `${rep.total_agents_scored || 0} agents | ${rep.total_attestations || 0} attestations`;

  if (!leaderboard.length) {
    container.innerHTML = '<div class="empty-state"><p>No reputation data</p></div>';
    return;
  }

  const trendSymbols = { improving: '\u2191', stable: '\u2192', declining: '\u2193' };

  container.innerHTML = `
    <table class="reputation-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Agent</th>
          <th>Composite</th>
          <th>Delivery</th>
          <th>Quality</th>
          <th>Pricing</th>
          <th>Compliance</th>
          <th>Reliability</th>
          <th>Txns</th>
          <th>Trend</th>
          <th>Chain</th>
        </tr>
      </thead>
      <tbody>
        ${leaderboard.map((r, i) => {
          const chain = chains[r.agent_id] || {};
          const composite_pct = (r.composite_score * 100).toFixed(1);
          const barColor = r.composite_score > 0.85 ? '#4CAF50' :
                           r.composite_score > 0.65 ? '#FF9800' : '#F44336';
          return `
            <tr>
              <td style="color:var(--text-muted)">${i + 1}</td>
              <td><span style="font-weight:600">${r.agent_name || r.agent_id}</span></td>
              <td>
                <span class="score-bar" style="width:${composite_pct * 0.6}px;background:${barColor}"></span>
                <span class="score-value" style="color:${barColor}">${composite_pct}%</span>
              </td>
              <td style="color:${r.delivery > 0.8 ? '#4CAF50' : '#FF9800'}">${(r.delivery * 100).toFixed(0)}%</td>
              <td style="color:${r.quality > 0.8 ? '#4CAF50' : '#FF9800'}">${(r.quality * 100).toFixed(0)}%</td>
              <td style="color:${r.pricing > 0.8 ? '#4CAF50' : '#FF9800'}">${(r.pricing * 100).toFixed(0)}%</td>
              <td style="color:${r.compliance > 0.8 ? '#4CAF50' : '#FF9800'}">${(r.compliance * 100).toFixed(0)}%</td>
              <td style="color:${r.reliability > 0.8 ? '#4CAF50' : '#FF9800'}">${(r.reliability * 100).toFixed(0)}%</td>
              <td style="color:var(--text-muted)">${r.transactions}</td>
              <td><span class="trend-indicator ${r.trend}">${trendSymbols[r.trend] || '-'} ${r.trend}</span></td>
              <td><span class="chain-badge ${chain.valid ? 'valid' : 'invalid'}">${chain.valid ? 'Verified' : 'Invalid'} (${chain.length || 0})</span></td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}
</script>
</body>
</html>
